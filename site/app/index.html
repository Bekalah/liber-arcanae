<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Liber Arcanae Pantheon Atlas</title>
  <meta name="description" content="Offline-first pantheon atlas for Codex 144:99 with ND-safe calm mode controls.">
  <link rel="canonical" href="https://liber-arcanae.local/app/">
  <meta name="theme-color" content="#6c5ba7">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="img/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="img/icons/icon-512.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>
  <header class="site-header" role="banner">
    <div class="site-identity">
      <h1>Liber Arcanae Pantheon Atlas</h1>
      <p>Layered geometry and tarot research channels held within Codex 144:99 for offline study.</p>
    </div>
    <button id="calm-toggle" class="calm-toggle" type="button" aria-pressed="false" aria-describedby="calm-note">
      <span class="calm-toggle__label">Calm mode off</span>
    </button>
  </header>
  <p id="calm-note" class="visually-hidden">Calm mode softens color contrast and disables motion for ND-safe review.</p>
  <main id="main" tabindex="-1">
    <section class="hero" aria-labelledby="hero-heading">
      <div class="hero-media">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO8N0a8AAAAASUVORK5CYII=" alt="Aurora gate gradient evoking Leonora Carrington constellations." loading="lazy" decoding="async" width="720" height="450">
      </div>
      <div class="hero-copy">
        <h2 id="hero-heading">Aurora Gate Research Anchor</h2>
        <p>This calm field is a grounded stand-in when Git LFS art is unavailable offline. It keeps the palette below 200 KB and honors the covenant&apos;s layered geometry request.</p>
      </div>
    </section>
    <section class="catalogue" aria-labelledby="pantheon-heading">
      <div class="catalogue-head">
        <h2 id="pantheon-heading">Pantheon Node Catalogue</h2>
        <p class="status-line" data-status role="status" aria-live="polite">Preparing node streamâ€¦</p>
      </div>
      <div id="node-list" class="node-list" role="list"></div>
    </section>
  </main>
  <footer class="site-footer">
    <p>Service worker keeps the atlas offline-first; manifest icons cover 192 and 512 requirements.</p>
  </footer>
  <script type="module">
    import { initNodeGallery } from './js/loadNodes.js';

    const statusEl = document.querySelector('[data-status]');
    const listEl = document.getElementById('node-list');
    const calmToggle = document.getElementById('calm-toggle');
    const calmLabel = calmToggle.querySelector('.calm-toggle__label');
    const storageKey = 'liber-arcanae.calm-mode';

    const mql = window.matchMedia('(prefers-reduced-motion: reduce)');

    const getStoredPreference = () => {
      try {
        return window.localStorage.getItem(storageKey);
      } catch (error) {
        console.warn('localStorage unavailable, calm mode defaults only.', error);
        return null;
      }
    };

    const setStoredPreference = (value) => {
      try {
        window.localStorage.setItem(storageKey, value);
      } catch (error) {
        console.warn('Unable to persist calm mode preference.', error);
      }
    };

    const syncCalmState = (active) => {
      calmToggle.setAttribute('aria-pressed', active ? 'true' : 'false');
      calmLabel.textContent = active ? 'Calm mode on' : 'Calm mode off';
    };

    const storedPreference = getStoredPreference();
    const startCalm = storedPreference === 'on' || (storedPreference === null && mql.matches);
    if (startCalm) {
      document.body.classList.add('calm-mode');
    }
    syncCalmState(document.body.classList.contains('calm-mode'));

    calmToggle.addEventListener('click', () => {
      const active = document.body.classList.toggle('calm-mode');
      syncCalmState(active);
      setStoredPreference(active ? 'on' : 'off');
    });

    const handleMotionChange = (event) => {
      if (getStoredPreference() !== null) {
        return;
      }
      if (event.matches) {
        document.body.classList.add('calm-mode');
      } else {
        document.body.classList.remove('calm-mode');
      }
      syncCalmState(document.body.classList.contains('calm-mode'));
    };

    if (typeof mql.addEventListener === 'function') {
      mql.addEventListener('change', handleMotionChange);
    } else if (typeof mql.addListener === 'function') {
      mql.addListener(handleMotionChange);
    }

    initNodeGallery({ listEl, statusEl });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch((error) => {
          console.warn('Service worker registration failed:', error);
        });
      });
    }
  </script>
</body>
</html>
